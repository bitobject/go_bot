# Makefile for building Docker images locally.
# This should be run from the deploy/build/ directory.

# Use the build-specific compose file and the .env file from the parent directory.
COMPOSE_CMD = docker-compose -f docker-compose.build.yml --env-file ../.env

.PHONY: all build deliver deploy app nginx help

.DEFAULT_GOAL := help

help: ## –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É
	@echo "Usage: make [target]"
	@echo ""
	@echo "Targets:"
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "  \033[1;33m%-10s\033[0m %s\n", $$1, $$2}' $(MAKEFILE_LIST)

all: build ## –°–æ–±—Ä–∞—Ç—å –≤—Å–µ –æ–±—Ä–∞–∑—ã (–¥–µ–π—Å—Ç–≤–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)

build: ## Build and save all images to .tar files
	@echo "üõ†Ô∏è  Building all images locally..."
	@$(COMPOSE_CMD) build --parallel
	@echo "üì¶  Saving images to .tar files..."
	@docker save $(APP_IMAGE_NAME):latest -o $(APP_IMAGE_NAME).tar
	@docker save $(NGINX_IMAGE_NAME):latest -o $(NGINX_IMAGE_NAME).tar
	@echo "‚úÖ Images saved to $(APP_IMAGE_NAME).tar and $(NGINX_IMAGE_NAME).tar"

app: ## –°–æ–±—Ä–∞—Ç—å –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ–±—Ä–∞–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤ .tar —Ñ–∞–π–ª
	@echo "üõ†Ô∏è  Building app image locally..."
	@$(COMPOSE_CMD) build app
	@echo "üì¶  Saving app image to $(APP_IMAGE_NAME).tar..."
	@docker save $(APP_IMAGE_NAME):latest -o $(APP_IMAGE_NAME).tar
	@echo "‚úÖ  Image saved to $(APP_IMAGE_NAME).tar"

nginx: ## –°–æ–±—Ä–∞—Ç—å –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ–±—Ä–∞–∑ nginx –≤ .tar —Ñ–∞–π–ª
	@echo "üõ†Ô∏è  Building nginx image locally..."
	@$(COMPOSE_CMD) build nginx
	@echo "üì¶  Saving nginx image to $(NGINX_IMAGE_NAME).tar..."
	@docker save $(NGINX_IMAGE_NAME):latest -o $(NGINX_IMAGE_NAME).tar
	@echo "‚úÖ  Image saved to $(NGINX_IMAGE_NAME).tar"

# ====================================================================================
# DEPLOYMENT
# ====================================================================================

deliver: build ## Deliver built images to the remote server
	@echo "üöö Delivering images to $(SSH_HOST)..."
	@scp $(APP_IMAGE_NAME).tar $(NGINX_IMAGE_NAME).tar $(SSH_USER)@$(SSH_HOST):$(DEPLOY_PATH)
	@echo "‚úÖ Images delivered successfully to $(DEPLOY_PATH) on $(SSH_HOST)!"

deploy: ## Deploy the application on the remote server using delivered images
	@echo "üîÑ Deploying and restarting services on $(SSH_HOST)..."
	@ssh $(SSH_USER)@$(SSH_HOST) '
		set -e; \
		cd $(DEPLOY_PATH); \
		echo "- Loading app image..."; \
		docker load < $(APP_IMAGE_NAME).tar; \
		echo "- Loading nginx image..."; \
		docker load < $(NGINX_IMAGE_NAME).tar; \
		echo "- Removing temporary .tar files..."; \
		rm $(APP_IMAGE_NAME).tar $(NGINX_IMAGE_NAME).tar; \
		echo "- Restarting services with docker-compose..."; \
		docker-compose --env-file .env up -d --force-recreate; \
	'
	@echo "‚úÖ Deployment finished successfully!"
